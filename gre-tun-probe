#!/bin/bash
function quit() {
        echo -e $1
        exit -1
}

function cleanup(){
        ovs-vsctl del-port $1 ${veths[0]}
        ip link del ${veths[0]}
}

test -n "$3" || quit "Usage: gre-tun-probe bridge gre_num out_port [SOURCE IP] [DEST IP] [DEST MAC] [number of probes]\nexample: gre-tun-probe br-tun 0x1 2"
test -x "`which ovs-vsctl`"|| quit "openvswitch not installed. Is this openstack host?"
test -x "`which nping`" || quit "nping not found. Nping can be found in newer verison of nmap. Unfortunately, Ubuntu 12.04's nmap is too old, upgrade it to raring/saucy/trusty"
test -x "`which ip`"|| quit "iproute2's ip command not found. This is not normal."
trap cleanup INT
trap cleanup HUP
bridge=$1
gre=$2
out=$3
ip link add type veth
veths=(`ip l |tail -n 4|egrep -o "veth[0-9]+"`)
#echo $veths
ip link set up dev ${veths[0]}
ip link set up dev ${veths[1]}

ip a a 240.0.0.1/24 dev ${veths[1]} #240.0.0.0 - experimental block ( == free for use for probing)
ovs-vsctl add-port $bridge ${veths[0]}

#TODO:
port=`ovs-ofctl dump-ports-desc $1|grep ${veths[0]}|head -n 1|awk -F '(' '{print $1}'` #assigned port number to the last port in bridge (race prone!)
rule_num=$((RANDOM + 1000)) #neutron use lower rules number
ovs-ofctl add-flow $bridge "priority=$rule_num,in_port=$port actions=set_tunnel:$gre,output:$out"
#set up ofctl rule to warp to GRE tunnel(s)
#send nping


cleanup

